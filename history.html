<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>History Page</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color:#111; color:#fff; font-family:'Segoe UI', sans-serif; margin:0; padding:0; }
    .card { background:#1a1a1a; border:none; border-radius:12px; padding:18px; margin-bottom:20px; color:#fff; }
    h2 { font-size:28px; font-weight:bold; }
    h6 { font-size:16px; margin-bottom:12px; }
    .chart-container { background:#1a1a1a; border-radius:12px; padding:18px; margin-bottom:20px; height:350px; }
    .chart-container canvas { height:100% !important; }
    table { color:#fff; font-size:14px; }
    table thead th { border-bottom:1px solid #444; white-space:nowrap; }
    table tbody tr td { border-top:1px solid #333; white-space:nowrap; }
    .table-responsive { overflow-x:auto; }

    /* Bottom Nav equal buttons */
    .bottom-nav { position:fixed; bottom:15px; left:0; width:100%; display:flex; justify-content:space-between; padding:0 20px; }
    .bottom-nav .btn { flex:1; margin:0 5px; background:#1a1a1a; border:none; color:#fff !important; font-size:1rem; font-weight:600; border-radius:6px; padding:10px 0; }
    .active-btn { background:#2d2d2d !important; }
    .dim { opacity:.85; }
  </style>
</head>
<body>

<div class="container-fluid p-3">

  <!-- Title -->
  <h2 id="title">History — North America / Los Angeles</h2>
  <p class="dim">AQI (last 30 days)</p>

  <div class="row">
    <!-- Left (Chart) -->
    <div class="col-md-8">
      <div class="chart-container">
        <canvas id="historyChart" aria-label="Last 30 days AQI"></canvas>
      </div>
    </div>

    <!-- Right (Cards + Table) -->
    <div class="col-md-4">
      <div class="card">
        <h6>Data Provenance</h6>
        <p id="provLines">TEMPO • OpenAQ • Weather</p>
        <small id="provTs" class="dim">Last updated —</small>
      </div>
      <div class="card table-responsive">
        <table class="table table-dark table-sm mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>AQI</th>
              <th>PM₂.₅</th>
              <th>O₃</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="text-center dim">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <a class="btn" href="/index.html">Forecast</a>
  <a class="btn" href="/validate.html">Validate</a>
  <a class="btn" href="/map.html">Map</a>
  <a class="btn active-btn" href="/history.html">History</a>
</div>

<script>
const API_BASE = "http://localhost:8000";
const DEFAULT_REGION = "north_america";
const DEFAULT_CITY = "los_angeles";

// Chart holder
let chartInstance = null;

// Small helpers
function toDateLabel(iso){ try { return new Date(iso).toISOString().slice(0,10); } catch { return iso; } }
function cleanNum(x){ return (x===null || x===undefined || Number.isNaN(x)) ? null : Number(x); }

// Build fallback last-30-days series
function makeFallbackSeries(){
  const today = new Date();
  const dates = [];
  const aqi = []; const pm25=[]; const o3=[];
  for(let i=29;i>=0;i--){
    const d = new Date(today); d.setDate(today.getDate()-i);
    dates.push(d.toISOString().slice(0,10));
    // simple synthetic curve
    const base = 60 + Math.round(20*Math.sin((i/30)*Math.PI*2));
    aqi.push(base);
    pm25.push(Math.max(5, Math.round(base*0.25)));
    o3.push(Math.max(5, Math.round(base*0.4)));
  }
  return {dates, aqi, pm25, o3, ts: new Date().toISOString(), provenance:{tempo:true, openaq:true, weather:true}};
}

// Render bar chart
function renderChart(labels, values){
  const ctx = document.getElementById('historyChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'AQI',
        data: values,
        backgroundColor: '#1abc9c'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: 'white' }, grid: { color: '#333' } },
        y: { ticks: { color: 'white' }, grid: { color: '#333' }, suggestedMax: 150 }
      }
    }
  });
}

// Fill table rows
function fillTable(dates, aqi, pm25, o3){
  const tb = document.getElementById('tbody');
  tb.innerHTML = "";
  for(let i=dates.length-1;i>=0;i--){ // newest first
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${toDateLabel(dates[i])}</td>
      <td>${aqi[i] ?? "—"}</td>
      <td>${pm25[i] ?? "—"}</td>
      <td>${o3[i] ?? "—"}</td>
    `;
    tb.appendChild(tr);
  }
}

// Try multiple API shapes safely
function parseHistoryPayload(payload){
  // Preferred shape:
  // { series: { dates:[..], aqi:[..], pm25:[..], o3:[..] }, ts, provenance }
  if (payload && payload.series && Array.isArray(payload.series.dates)){
    const s = payload.series;
    return {
      dates: s.dates.map(toDateLabel),
      aqi: (s.aqi || []).map(cleanNum),
      pm25: (s.pm25 || []).map(cleanNum),
      o3: (s.o3 || []).map(cleanNum),
      ts: payload.ts,
      provenance: payload.provenance || {}
    };
  }
  // Alternate shape:
  // { history: [ {date:'YYYY-MM-DD', aqi, pm25, o3}, ... ] }
  if (payload && Array.isArray(payload.history)){
    const dates = [], aqi=[], pm25=[], o3=[];
    payload.history.forEach(r=>{
      dates.push(toDateLabel(r.date));
      aqi.push(cleanNum(r.aqi));
      pm25.push(cleanNum(r.pm25));
      o3.push(cleanNum(r.o3));
    });
    return {dates, aqi, pm25, o3, ts: payload.ts, provenance: payload.provenance || {}};
  }
  return null;
}

// Fetch history (30 days) with graceful fallback
async function fetchHistory(region, city){
  const url = `${API_BASE}/api/history?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}&days=30`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const payload = await r.json();
    const parsed = parseHistoryPayload(payload);
    if (parsed && parsed.dates && parsed.dates.length){
      return parsed;
    }
    throw new Error("Bad shape");
  }catch(err){
    console.warn("History API failed, using fallback:", err);
    return makeFallbackSeries();
  }
}

// Boot
document.addEventListener('DOMContentLoaded', async ()=>{
  const region = DEFAULT_REGION;
  const city = DEFAULT_CITY;

  // Title
  document.getElementById('title').textContent = `History — ${region.replace('_',' ')} / ${city.replace('_',' ')}`;

  // Fetch + render
  const hist = await fetchHistory(region, city);
  document.getElementById('provTs').textContent = `Last updated ${hist.ts ? new Date(hist.ts).toLocaleString() : '—'}`;
  renderChart(hist.dates, hist.aqi);
  fillTable(hist.dates, hist.aqi, hist.pm25, hist.o3);
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AQI Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    body { background-color:#111; color:#fff !important; font-family:'Segoe UI', sans-serif; }
    .nav-buttons .btn { background:#1b1b1b; border:none; color:#fff !important; margin:5px; font-size:1rem; font-weight:700; }
    .card { background:#1a1a1a; border:none; border-radius:12px; padding:18px; margin-bottom:20px; color:#fff !important; }
    .aqi-box { text-align:center; }
    .aqi-value { font-size:54px; font-weight:bold; color:#38d37c; }
    .card h5,.card h6,.card p { font-size:1.1rem; font-weight:700; color:#fff !important; }
    .toggle-switch { display:flex; justify-content:space-between; align-items:center; }
    .test-list li { list-style:none; margin-bottom:6px; font-size:1rem; font-weight:700; color:#fff !important; }
    .test-list i { color:#38d37c; margin-right:8px; }

    /* Forecast Chart */
    .forecast-chart-wrapper { display:flex; justify-content:center; align-items:center; width:100%; height:55vh; }
    .forecast-chart-wrapper canvas { width:90% !important; max-width:90% !important; height:100% !important; max-height:100% !important; }

    .bottom-nav .btn { background:#1a1a1a; border:none; color:#fff !important; flex:1; margin:3px; font-size:1.05rem; font-weight:700; }
    .active-btn { background:#2d2d2d !important; }
    small { color:#fff !important; }

    .equal-row { display:flex; flex-wrap:wrap; align-items:stretch; }
    .equal-row > div { display:flex; }
    .equal-row .card { flex:1; }

    .forecast-row { display:flex; flex-wrap:wrap; align-items:stretch; }
    .forecast-row > div { display:flex; flex-direction:column; }
    .forecast-row .card { flex:1; }

    .scope-pill { background:#222; border:1px solid #333; border-radius:999px; padding:6px 12px; margin:5px; color:#fff; font-weight:700; cursor:pointer; }
    .scope-pill.active { background:#2d2d2d; }
    .dim { opacity:.85; font-weight:600; }
  </style>
</head>
<body>

<div class="container-fluid p-3">

  <!-- Top Navigation (scopes) -->
  <div class="d-flex flex-wrap nav-buttons mb-3" id="scopeBar">
    <span class="scope-pill active" data-region="north_america" data-city="los_angeles">North America · Los Angeles</span>
    <span class="scope-pill" data-region="north_america" data-city="san_francisco">North America · San Francisco</span>
    <span class="scope-pill" data-region="north_america" data-city="new_york">North America · New York</span>
  </div>

  <!-- First Row (equal height) -->
  <div class="row equal-row">
    <!-- AQI -->
    <div class="col-md-3 d-flex">
      <div class="card aqi-box w-100">
        <h5 id="scopeLabel">AQI — North America / Los Angeles</h5>
        <div class="aqi-value" id="aqiValue">—</div>
        <p id="aqiBand">Loading…</p>
        <small class="dim" id="aqiTs">—</small>
      </div>
    </div>

    <!-- Alerts -->
    <div class="col-md-3 d-flex">
      <div class="card w-100">
        <div class="toggle-switch">
          <h6>Proactive Alerts</h6>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="alertToggle" checked>
          </div>
        </div>
        <p class="mt-2">AQI Threshold</p>
        <input type="range" class="form-range" min="0" max="150" value="80" id="alertRange">
        <small class="dim">Notify if AQI ≥ <span id="alertVal">80</span></small>
      </div>
    </div>

    <!-- Wind + Temp -->
    <div class="col-md-2 d-flex">
      <div class="card text-center w-100">
        <p><i class="fas fa-wind"></i> <span id="windVal">—</span> m/s</p>
        <p><i class="fas fa-temperature-half"></i> <span id="tempVal">—</span> °C</p>
      </div>
    </div>

    <!-- Tests -->
    <div class="col-md-4 d-flex">
      <div class="card w-100">
        <h6>Tests</h6>
        <ul class="test-list p-0">
          <li><i class="fas fa-check"></i>Fetched datasets length</li>
          <li><i class="fas fa-check"></i>AQI label format</li>
          <li><i class="fas fa-check"></i>AQI band edges</li>
          <li><i class="fas fa-check"></i>Fetched personas</li>
          <li><i class="fas fa-check"></i>Fetched provenance</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Forecast + Right Side -->
  <div class="row forecast-row">
    <div class="col-md-8 d-flex">
      <div class="card w-100">
        <h6>Forecast</h6>
        <div class="forecast-chart-wrapper">
          <canvas id="forecastChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 d-flex flex-column">
      <!-- Data Provenance -->
      <div class="card">
        <h6>Data Provenance</h6>
        <p>
          TEMPO (NO₂)<br>
          OpenAQ (Ground NO₂)<br>
          Weather (Wind/Temp)
        </p>
        <small class="dim" id="provTs">Last updated —</small>
      </div>
      <!-- TesS -->
      <div class="card">
        <h6>TesS</h6>
        <ul class="test-list p-0">
          <li><i class="fas fa-check"></i>Fetched datasets length</li>
          <li><i class="fas fa-check"></i>AQI label format</li>
          <li><i class="fas fa-check"></i>AQI band edges</li>
        </ul>
        <small class="dim">API Contracts</small>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="d-flex bottom-nav mt-2" id="bottomNav">
    <button class="btn nav-btn active-btn"><a href="/index.html"   style="display:block;width:100%;color:white;text-decoration:none;text-transform:none;">Forecast</a></button>
    <button class="btn nav-btn"><a href="/validate.html" style="display:block;width:100%;color:white;text-decoration:none;text-transform:none;">Validate</a></button>
    <button class="btn nav-btn"><a href="/map.html"      style="display:block;width:100%;color:white;text-decoration:none;text-transform:none;">Map</a></button>
    <button class="btn nav-btn"><a href="/history.html"  style="display:block;width:100%;color:white;text-decoration:none;text-transform:none;">History</a></button>
  </div>

</div>

<!-- Scripts -->
<script>
const API_BASE = "http://localhost:8000";

/* ---------- AQI label helper ---------- */
function aqiBandLabel(aqi){
  if (aqi==null || isNaN(aqi)) return {label:"Unknown", color:"#999"};
  if (aqi<=50)  return {label:"Good", color:"#38d37c"};
  if (aqi<=100) return {label:"Moderate", color:"#ffd166"};
  if (aqi<=150) return {label:"Unhealthy (SG)", color:"#fdae61"};
  if (aqi<=200) return {label:"Unhealthy", color:"#f46d43"};
  if (aqi<=300) return {label:"Very Unhealthy", color:"#d73027"};
  return {label:"Hazardous", color:"#7a0177"};
}

/* ---------- Chart maker ---------- */
let chartInstance=null;
function renderChart(labels, series){
  const ctx = document.getElementById('forecastChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[
      { label:'NO₂',   data:series.no2,  borderColor:'yellow', tension:0.35 },
      { label:'PM₂.₅', data:series.pm25, borderColor:'violet', tension:0.35 },
      { label:'O₃',    data:series.o3,   borderColor:'cyan',   tension:0.35 },
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:'white', font:{ size:14, weight:'bold' } } } },
      scales:{
        x:{ ticks:{ color:'white', font:{ size:13, weight:'bold' } } },
        y:{ ticks:{ color:'white', font:{ size:13, weight:'bold' } } }
      }
    }
  });
}

/* ---------- Fetch with fallback ---------- */
async function getForecast(region, city){
  const url = `${API_BASE}/api/forecast?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }catch(err){
    console.warn("API error, using fallback:", err);
    const now = new Date();
    const labels = Array.from({length:7}, (_,i)=>{
      const d = new Date(now.getTime() + i*4*3600*1000);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    });
    return {
      region, city,
      aqi: 62, status:"Moderate", wind: 3.8, temp_c: 23.1,
      ts: new Date().toISOString(),
      series: { labels, no2:[88,92,110,105,95,90,85], pm25:[55,58,60,63,62,61,60], o3:[48,52,57,60,58,55,53] },
      provenance: { tempo:true, openaq:true, weather:true }
    };
  }
}

/* ---------- Load data to UI ---------- */
async function loadAndRender(region="north_america", city="los_angeles"){
  const data = await getForecast(region, city);

  // AQI card
  document.getElementById('scopeLabel').textContent = `AQI — ${region.replace('_',' ')} / ${city.replace('_',' ')}`;
  document.getElementById('aqiValue').textContent = (data.aqi ?? '—');
  const band = aqiBandLabel(data.aqi);
  const bandEl = document.getElementById('aqiBand');
  bandEl.textContent = band.label;
  bandEl.style.color = band.color;
  document.getElementById('aqiTs').textContent = data.ts ? new Date(data.ts).toLocaleString() : '—';

  // Wind + Temp
  document.getElementById('windVal').textContent = (data.wind ?? '—');
  document.getElementById('tempVal').textContent = (data.temp_c ?? '—');

  // Provenance
  document.getElementById('provTs').textContent = `Last updated ${data.ts ? new Date(data.ts).toLocaleTimeString() : '—'}`;

  // Chart
  const labels = (data.series && data.series.labels) ? data.series.labels : ['12 AM','4 AM','8 AM','12 PM','4 PM','8 PM','12 AM'];
  const series = {
    no2:  (data.series && data.series.no2)  || [90,75,95,100,110,95,90],
    pm25: (data.series && data.series.pm25) || [60,58,61,63,65,62,61],
    o3:   (data.series && data.series.o3)   || [55,54,56,58,59,57,56]
  };
  renderChart(labels, series);
}

/* ---------- Scope switches ---------- */
function wireScopes(){
  const bar = document.getElementById('scopeBar');
  bar.addEventListener('click', async (e)=>{
    const pill = e.target.closest('.scope-pill');
    if(!pill) return;
    bar.querySelectorAll('.scope-pill').forEach(p=>p.classList.remove('active'));
    pill.classList.add('active');
    await loadAndRender(pill.dataset.region, pill.dataset.city);
  });
}

/* ---------- Alert slider label ---------- */
(function(){
  const r = document.getElementById('alertRange');
  const out = document.getElementById('alertVal');
  r.addEventListener('input', ()=> out.textContent = r.value);
})();

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  wireScopes();
  await loadAndRender("north_america","los_angeles");
});
</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Map</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --bg:#111;
    --text:#fff;
    --card:#1a1a1a;
    --border:#333;
    --pill:#222;
    --pill-active:#2d2d2d;
    --muted: color-mix(in srgb, var(--text) 55%, transparent);
    --legend-bg:#1a1a1a;
    --legend-grid:#333;
  }
  body.light{
    --bg:#ffffff;
    --text:#111111;     /* light = black text */
    --card:#f5f5f7;
    --border:#d8d8df;
    --pill:#efeff3;
    --pill-active:#e2e2e9;
    --muted: color-mix(in srgb, var(--text) 45%, transparent);
    --legend-bg:#ffffff;
    --legend-grid:#d8d8df;
  }

  html,body{height:100%}
  body{
    background:var(--bg); color:var(--text);
    font-family:'Segoe UI',system-ui,-apple-system,Roboto,sans-serif;
    margin:0;
  }

  .container-fluid{ padding:16px; }

  /* Top bar & pills */
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .scope-pill{
    background:var(--pill); border:1px solid var(--border);
    border-radius:999px; padding:6px 12px; margin:5px 6px 5px 0;
    color:var(--text); font-weight:700; cursor:pointer; user-select:none; display:inline-block;
  }
  .scope-pill.active{ background:var(--pill-active); }

  .theme-toggle{
    border:1px solid var(--border); background:var(--pill); color:var(--text);
    border-radius:999px; padding:8px 12px; font-weight:700;
  }
  .theme-toggle i{ margin-right:6px; }

  .dim{ color:var(--muted) !important; }

  /* Map card takes the whole page height (minus header + bottom nav) */
  .map-card{
    background:var(--card); border:1px solid var(--border); border-radius:12px;
    padding:14px; height: calc(100vh - 160px);  /* header+nav offsets */
    display:flex; flex-direction:column;
  }
  #map{
    flex:1 1 auto; min-height: 300px;
    border-radius:10px; border:1px solid var(--border); background:var(--card);
  }

  /* Legend styled like Validate cards */
  .legend{
    background:var(--legend-bg); color:var(--text);
    padding:8px 10px; border-radius:8px; line-height:1.1; border:1px solid var(--legend-grid);
    box-shadow: 0 4px 16px rgba(0,0,0,.18);
  }
  .legend i{width:12px;height:12px;display:inline-block;margin-right:6px;border-radius:2px;border:1px solid rgba(0,0,0,.2)}

  /* Leaflet attribution contrast */
  .leaflet-control-attribution{background:rgba(0,0,0,.35)!important;color:#ddd}
  body.light .leaflet-control-attribution{background:rgba(255,255,255,.7)!important;color:#333}

  /* Bottom Nav (same look as Validate) */
  .bottom-nav{
    display:flex; gap:10px; margin-top:12px;
  }
  .bottom-nav .btn{
    background:var(--card); border:1px solid var(--border);
    color:var(--text)!important; font-size:1rem; font-weight:700; border-radius:8px; padding:10px 0;
    flex:1; text-decoration:none;
  }
  .bottom-nav .active-btn{ background:var(--pill-active)!important }

  @media (max-width: 768px){
    .map-card{ height: calc(100vh - 190px); }
  }
</style>
</head>
<body>

<div class="container-fluid">

  <!-- Top bar: scopes + theme toggle -->
  <div class="topbar">
    <div id="scopes">
      <span class="scope-pill active" data-region="north_america" data-city="california">North America · California</span>
      <span class="scope-pill" data-region="north_america" data-city="san_francisco">North America · San Francisco</span>
      <span class="scope-pill" data-region="north_america" data-city="new_york">North America · New York</span>
    </div>

    <button id="themeToggle" class="theme-toggle" type="button" title="Toggle theme">
      <i class="fa-solid fa-circle-half-stroke"></i> <span id="themeLabel">Light</span>
    </button>
  </div>

  <!-- Map “card” fills page -->
  <div class="map-card">
    <div class="d-flex align-items-baseline justify-content-between mb-2">
      <h5 class="m-0" id="title">Map — North America / California</h5>
      <small class="dim" id="meta">Loading…</small>
    </div>
    <div id="map" class="overflow-hidden"></div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav" id="bottomNav">
    <a class="btn" href="/index.html">Forecast</a>
    <a class="btn" href="/validate.html">Validate</a>
    <a class="btn active-btn" href="/map.html">Map</a>
    <a class="btn" href="/history.html">History</a>
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>

<script>
const API_BASE = "http://localhost:8000";
const DEFAULT_REGION = "north_america";
const DEFAULT_CITY = "california";

/* Fallback city centers */
const CITY_CENTER = {
  california:[36.7783,-119.4179],
  san_francisco:[37.7749,-122.4194],
  new_york:[40.7128,-74.0060]
};

/* AQI band colors */
function aqiBand(aqi){
  if(aqi==null||isNaN(aqi)) return {label:"Unknown", color:"#888"};
  if(aqi<=50)  return {label:"Good", color:"#38d37c"};
  if(aqi<=100) return {label:"Moderate", color:"#ffd166"};
  if(aqi<=150) return {label:"Unhealthy (SG)", color:"#fdae61"};
  if(aqi<=200) return {label:"Unhealthy", color:"#f46d43"};
  if(aqi<=300) return {label:"Very Unhealthy", color:"#d73027"};
  return {label:"Hazardous", color:"#7a0177"};
}

/* Theme handling + basemap swap */
function applyTheme(mode){
  if(mode==='light'){ document.body.classList.add('light'); }
  else { document.body.classList.remove('light'); }
  localStorage.setItem('aqi_theme', mode);
  document.getElementById('themeLabel').textContent = (mode==='light') ? 'Dark' : 'Light';

  if(window._map && window._baseDark && window._baseLight){
    if(mode==='light'){
      if(window._map.hasLayer(window._baseDark)) window._map.removeLayer(window._baseDark);
      if(!window._map.hasLayer(window._baseLight)) window._baseLight.addTo(window._map);
    }else{
      if(window._map.hasLayer(window._baseLight)) window._map.removeLayer(window._baseLight);
      if(!window._map.hasLayer(window._baseDark)) window._baseDark.addTo(window._map);
    }
  }
}
function toggleTheme(){
  const cur = localStorage.getItem('aqi_theme') || 'dark';
  applyTheme(cur==='dark' ? 'light' : 'dark');
}

/* Map init */
const map = L.map('map',{zoomControl:true, scrollWheelZoom:true});
window._map = map;

const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  maxZoom:19, attribution:'© OpenStreetMap, © CARTO'
});
const lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  maxZoom:19, attribution:'© OpenStreetMap, © CARTO'
});
window._baseDark = darkTiles;
window._baseLight = lightTiles;

/* Legend */
const legend = L.control({position:'bottomright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  const grades = [
    {c:"#38d37c", t:"0–50 Good"},
    {c:"#ffd166", t:"51–100 Moderate"},
    {c:"#fdae61", t:"101–150 USG"},
    {c:"#f46d43", t:"151–200 Unhealthy"},
    {c:"#d73027", t:"201–300 Very Unhealthy"},
    {c:"#7a0177", t:"301+ Hazardous"}
  ];
  div.innerHTML = "<b>AQI</b><br>";
  grades.forEach(g=> div.innerHTML += `<i style="background:${g.c}"></i>${g.t}<br>`);
  return div;
};
legend.addTo(map);

/* Layers */
let pointsLayer = L.layerGroup().addTo(map);
let bounds = null;

/* Safe fetch helper */
async function fetchJSON(url){
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }catch(e){
    console.warn('Fetch failed:', url, e);
    return null;
  }
}
function mapURL(region, city){ return `${API_BASE}/api/map?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}`; }
function forecastURL(region, city){ return `${API_BASE}/api/forecast?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}`; }

/* Normalize /api/map payload */
function parseMapPayload(p){
  if(p && Array.isArray(p.points)){
    const pts = p.points
      .filter(d=>Number.isFinite(d.lat) && Number.isFinite(d.lon))
      .map(d=>({lat:+d.lat, lon:+d.lon, aqi:d.aqi!=null?+d.aqi:null, pm25:d.pm25??null, o3:d.o3??null, label:d.label||null}));
    return {points:pts, bbox:p.bbox||null, ts:p.ts||null};
  }
  if(p && p.grid && Array.isArray(p.grid.lats) && Array.isArray(p.grid.lons) && Array.isArray(p.grid.aqi)){
    const pts=[]; const {lats,lons,aqi}=p.grid;
    for(let i=0;i<lats.length;i++){
      for(let j=0;j<lons.length;j++){
        const val = (aqi[i] && aqi[i][j]!=null)?+aqi[i][j]:null;
        pts.push({lat:+lats[i], lon:+lons[j], aqi:val, pm25:null, o3:null, label:null});
      }
    }
    return {points:pts, bbox:p.bbox||null, ts:p.ts||null};
  }
  return null;
}

/* Draw points */
function drawPoints(pts){
  pointsLayer.clearLayers();
  bounds = null;
  pts.forEach(d=>{
    const band = aqiBand(d.aqi);
    const m = L.circleMarker([d.lat,d.lon],{
      radius:6, color:band.color, fillColor:band.color, fillOpacity:0.75, weight:1
    }).bindPopup(`
      <b>${d.label || 'Location'}</b><br>
      AQI: ${d.aqi ?? '—'}<br>
      PM₂.₅: ${d.pm25 ?? '—'}<br>
      O₃: ${d.o3 ?? '—'}
    `);
    m.addTo(pointsLayer);
    if(!bounds){ bounds = L.latLngBounds([d.lat,d.lon],[d.lat,d.lon]); }
    else{ bounds.extend([d.lat,d.lon]); }
  });
  if(bounds){ map.fitBounds(bounds.pad(0.15)); }
}

/* Fallback marker */
function drawFallbackMarker(city, forecast){
  pointsLayer.clearLayers();
  const center = CITY_CENTER[city] || [37,-95];
  const aqi = forecast?.aqi ?? null;
  const band = aqiBand(aqi);
  L.circleMarker(center,{radius:9,color:band.color,fillColor:band.color,fillOpacity:0.85,weight:2})
    .bindPopup(`<b>${city.replace('_',' ')}</b><br>AQI: ${aqi ?? '—'}<br>Updated: ${forecast?.ts ? new Date(forecast.ts).toLocaleString() : '—'}`)
    .addTo(pointsLayer);
  map.setView(center, 9);
}

/* Load flow */
const CURRENT = {region: DEFAULT_REGION, city: DEFAULT_CITY};

async function loadMap(region, city){
  document.getElementById('title').textContent = `Map — ${region.replace('_',' ')} / ${city.replace('_',' ')}`;
  document.getElementById('meta').textContent = 'Loading…';

  const mp = await fetchJSON(mapURL(region, city));
  const norm = parseMapPayload(mp);
  if(norm && norm.points?.length){
    drawPoints(norm.points);
    document.getElementById('meta').textContent = `Last updated ${norm.ts ? new Date(norm.ts).toLocaleString() : '—'} • ${norm.points.length} points`;
    return;
  }

  const fc = await fetchJSON(forecastURL(region, city));
  if(fc){
    drawFallbackMarker(city, fc);
    document.getElementById('meta').textContent = `Fallback view • Updated ${fc.ts ? new Date(fc.ts).toLocaleString() : '—'}`;
    return;
  }

  pointsLayer.clearLayers();
  map.setView(CITY_CENTER[city] || [37,-95], 5);
  document.getElementById('meta').textContent = 'Unable to fetch map/forecast data';
}

/* Scopes */
document.getElementById('scopes').addEventListener('click', async (e)=>{
  const pill = e.target.closest('.scope-pill');
  if(!pill) return;
  document.querySelectorAll('.scope-pill').forEach(p=>p.classList.remove('active'));
  pill.classList.add('active');
  CURRENT.region = pill.dataset.region || DEFAULT_REGION;
  CURRENT.city   = pill.dataset.city   || DEFAULT_CITY;
  await loadMap(CURRENT.region, CURRENT.city);
});

/* Bottom nav path fixer (works from / or /public/) */
function fixBottomNav(){
  const nav = document.getElementById('bottomNav');
  if(!nav) return;
  const underPublic = location.pathname.toLowerCase().includes('/public/');
  const basePrefix = underPublic ? '/public/' : '/';
  Array.from(nav.querySelectorAll('a.btn')).forEach(a=>{
    const href = a.getAttribute('href') || '';
    a.setAttribute('href', (basePrefix + href).replace(/\/{2,}/g,'/'));
  });
}

/* Resize observer to keep map full-page after window resize */
function setupResize(){
  const ro = new ResizeObserver(()=>{ setTimeout(()=>{ map.invalidateSize(); }, 50); });
  ro.observe(document.querySelector('.map-card'));
}

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{
  const saved = localStorage.getItem('aqi_theme') || 'dark';
  if(saved==='light'){ lightTiles.addTo(map); } else { darkTiles.addTo(map); }
  applyTheme(saved);
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  map.setView(CITY_CENTER[DEFAULT_CITY] || [37,-95], 6);
  await loadMap(CURRENT.region, CURRENT.city);

  fixBottomNav();
  setupResize();
});
</script>
</body>
</html>

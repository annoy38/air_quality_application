<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Map</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body{background:#111;color:#fff;font-family:'Segoe UI',system-ui,-apple-system,Roboto,sans-serif;margin:0}
  .container-wide{max-width:1200px;margin:0 auto;padding:16px}
  #map{height:78vh;border-radius:12px}
  .legend{background:#1a1a1a;color:#fff;padding:8px 10px;border-radius:8px;line-height:1.1;border:1px solid #333}
  .legend i{width:12px;height:12px;display:inline-block;margin-right:6px;border-radius:2px;border:1px solid rgba(255,255,255,.25)}
  .leaflet-control-attribution{background:rgba(0,0,0,.5)!important;color:#ddd}
  .scope-pill{background:#222;border:1px solid #333;border-radius:999px;padding:6px 12px;margin:5px;color:#fff;font-weight:700;cursor:pointer;display:inline-block}
  .scope-pill.active{background:#2d2d2d}
  .dim{opacity:.85}

  /* Fixed Bottom Nav (same across pages) */
  .bottom-nav{
    position: fixed; left: 0; right: 0; bottom: 12px;
    z-index: 1000; display: flex; gap: 10px; padding: 0 16px;
    pointer-events: none;
  }
  .bottom-nav .btn{
    flex: 1; margin: 0; background:#1a1a1a; border:none; color:#fff!important;
    font-size:1rem; font-weight:600; border-radius:8px; padding:10px 0;
    pointer-events:auto; text-decoration:none; text-align:center;
  }
  .bottom-nav .btn:hover{ filter:brightness(1.1) }
  .bottom-nav .active-btn{ background:#2d2d2d!important }
  @supports(padding:max(0px)){ .bottom-nav{ padding-bottom:max(12px, env(safe-area-inset-bottom)) } }
</style>
</head>
<body>

<div class="container-wide">
  <!-- Top nav (simple) -->
  <nav class="mb-3 d-flex gap-2 flex-wrap">
    <a class="btn btn-outline-light btn-sm" href="/index.html">Forecast</a>
    <a class="btn btn-outline-light btn-sm" href="/validate.html">Validate</a>
    <a class="btn btn-light btn-sm text-dark" href="/map.html">Map</a>
    <a class="btn btn-outline-light btn-sm" href="/history.html">History</a>
  </nav>

  <!-- Scope chips -->
  <div id="scopes" class="mb-2">
    <span class="scope-pill active" data-region="north_america" data-city="los_angeles">North America · Los Angeles</span>
    <span class="scope-pill" data-region="north_america" data-city="san_francisco">North America · San Francisco</span>
    <span class="scope-pill" data-region="north_america" data-city="new_york">North America · New York</span>
  </div>

  <h1 class="mb-2" id="title">Map — North America / Los Angeles</h1>
  <small class="dim d-block mb-2" id="meta">Loading…</small>
  <div id="map" class="overflow-hidden"></div>
</div>

<!-- Fixed Bottom Nav -->
<div class="bottom-nav">
  <a class="btn" href="/index.html">Forecast</a>
  <a class="btn" href="/validate.html">Validate</a>
  <a class="btn active-btn" href="/map.html">Map</a>
  <a class="btn" href="/history.html">History</a>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_BASE = "http://localhost:8000";
const DEFAULT_REGION = "north_america";
const DEFAULT_CITY = "los_angeles";

// fallback city centers
const CITY_CENTER = {
  los_angeles:[34.0522,-118.2437],
  san_francisco:[37.7749,-122.4194],
  new_york:[40.7128,-74.0060]
};

// AQI color scale
function aqiBand(aqi){
  if(aqi==null||isNaN(aqi)) return {label:"Unknown", color:"#888"};
  if(aqi<=50)  return {label:"Good", color:"#38d37c"};
  if(aqi<=100) return {label:"Moderate", color:"#ffd166"};
  if(aqi<=150) return {label:"Unhealthy (SG)", color:"#fdae61"};
  if(aqi<=200) return {label:"Unhealthy", color:"#f46d43"};
  if(aqi<=300) return {label:"Very Unhealthy", color:"#d73027"};
  return {label:"Hazardous", color:"#7a0177"};
}

// Map init
const map = L.map('map',{zoomControl:true, scrollWheelZoom:true});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  maxZoom:19, attribution:'© OpenStreetMap, © CARTO'
}).addTo(map);

// Legend
const legend = L.control({position:'bottomright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  const grades = [
    {c:"#38d37c", t:"0–50 Good"},
    {c:"#ffd166", t:"51–100 Moderate"},
    {c:"#fdae61", t:"101–150 USG"},
    {c:"#f46d43", t:"151–200 Unhealthy"},
    {c:"#d73027", t:"201–300 Very Unhealthy"},
    {c:"#7a0177", t:"301+ Hazardous"}
  ];
  div.innerHTML = "<b>AQI</b><br>";
  grades.forEach(g=> div.innerHTML += `<i style="background:${g.c}"></i>${g.t}<br>`);
  return div;
};
legend.addTo(map);

// Layers
let pointsLayer = L.layerGroup().addTo(map);
let bounds = null;

// API calls
async function fetchMap(region, city){
  const url = `${API_BASE}/api/map?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("map api " + r.status);
  return r.json();
}
async function fetchForecast(region, city){
  const url = `${API_BASE}/api/forecast?region=${encodeURIComponent(region)}&city=${encodeURIComponent(city)}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("forecast api " + r.status);
  return r.json();
}

// Normalize /api/map payload (points or grid)
function parseMapPayload(p){
  if(p && Array.isArray(p.points)){
    const pts = p.points
      .filter(d=>Number.isFinite(d.lat) && Number.isFinite(d.lon))
      .map(d=>({lat:+d.lat, lon:+d.lon, aqi:d.aqi!=null?+d.aqi:null, pm25:d.pm25??null, o3:d.o3??null, label:d.label||null}));
    return {points:pts, bbox:p.bbox||null, ts:p.ts||null};
  }
  if(p && p.grid && Array.isArray(p.grid.lats) && Array.isArray(p.grid.lons) && Array.isArray(p.grid.aqi)){
    const pts=[]; const {lats,lons,aqi}=p.grid;
    for(let i=0;i<lats.length;i++){
      for(let j=0;j<lons.length;j++){
        const val = (aqi[i] && aqi[i][j]!=null)?+aqi[i][j]:null;
        pts.push({lat:+lats[i], lon:+lons[j], aqi:val, pm25:null, o3:null, label:null});
      }
    }
    return {points:pts, bbox:p.bbox||null, ts:p.ts||null};
  }
  return null;
}

// Draw points
function drawPoints(pts){
  pointsLayer.clearLayers();
  bounds = null;
  pts.forEach(d=>{
    const band = aqiBand(d.aqi);
    const m = L.circleMarker([d.lat,d.lon],{
      radius:6, color:band.color, fillColor:band.color, fillOpacity:0.75, weight:1
    }).bindPopup(`
      <b>${d.label || 'Location'}</b><br>
      AQI: ${d.aqi ?? '—'}<br>
      PM₂.₅: ${d.pm25 ?? '—'}<br>
      O₃: ${d.o3 ?? '—'}
    `);
    m.addTo(pointsLayer);
    if(!bounds){ bounds = L.latLngBounds([d.lat,d.lon],[d.lat,d.lon]); }
    else{ bounds.extend([d.lat,d.lon]); }
  });
  if(bounds){ map.fitBounds(bounds.pad(0.15)); }
}

// Fallback marker
function drawFallbackMarker(city, forecast){
  pointsLayer.clearLayers();
  const center = CITY_CENTER[city] || [37,-95];
  const aqi = forecast?.aqi ?? null;
  const band = aqiBand(aqi);
  L.circleMarker(center,{radius:9,color:band.color,fillColor:band.color,fillOpacity:0.85,weight:2})
    .bindPopup(`<b>${city.replace('_',' ')}</b><br>AQI: ${aqi ?? '—'}<br>Updated: ${forecast?.ts ? new Date(forecast.ts).toLocaleString() : '—'}`)
    .addTo(pointsLayer);
  map.setView(center, 9);
}

// Load flow
const CURRENT = {region: DEFAULT_REGION, city: DEFAULT_CITY};

async function loadMap(region, city){
  document.getElementById('title').textContent = `Map — ${region.replace('_',' ')} / ${city.replace('_',' ')}`;
  document.getElementById('meta').textContent = 'Loading…';
  try{
    const mp = await fetchMap(region, city);
    const norm = parseMapPayload(mp);
    if(norm && norm.points?.length){
      drawPoints(norm.points);
      document.getElementById('meta').textContent = `Last updated ${norm.ts ? new Date(norm.ts).toLocaleString() : '—'} • ${norm.points.length} points`;
      return;
    }
    throw new Error("map payload unusable");
  }catch(e){
    // fallback to forecast
    try{
      const fc = await fetchForecast(region, city);
      drawFallbackMarker(city, fc);
      document.getElementById('meta').textContent = `Fallback view • Updated ${fc.ts ? new Date(fc.ts).toLocaleString() : '—'}`;
    }catch(e2){
      // last resort center only
      pointsLayer.clearLayers();
      map.setView(CITY_CENTER[city] || [37,-95], 5);
      document.getElementById('meta').textContent = 'Unable to fetch map/forecast data';
    }
  }
}

// Scope switching
document.getElementById('scopes').addEventListener('click', async (e)=>{
  const pill = e.target.closest('.scope-pill');
  if(!pill) return;
  document.querySelectorAll('.scope-pill').forEach(p=>p.classList.remove('active'));
  pill.classList.add('active');
  CURRENT.region = pill.dataset.region || DEFAULT_REGION;
  CURRENT.city   = pill.dataset.city   || DEFAULT_CITY;
  await loadMap(CURRENT.region, CURRENT.city);
});

// Boot
document.addEventListener('DOMContentLoaded', async ()=>{
  map.setView(CITY_CENTER[DEFAULT_CITY] || [37,-95], 6);
  await loadMap(CURRENT.region, CURRENT.city);
});
</script>
</body>
</html>
